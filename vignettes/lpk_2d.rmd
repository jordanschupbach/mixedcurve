---
title: "Nadaraya-Watson (2d) Kernel Regression"
author: "Jordan Schupbach"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Nadaraya-Watson (2d) Kernel Regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- {{{ Setup -->
```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
<!-- }}} Setup -->

## Introduction

This vignette demonstrates how to use the `mixedcurve` package to fit a
Nadaraya-Watson kernel regression model to two-dimensional data.

## Example Usage

Let's start by simulating some data according to the m2 Cuevas et al. function
modified to two dimensions:

<!-- {{{ Generate data -->

```{r, fig.filename="doppler_2d_data.png", fig.width=10, fig.height=10, out.width="98%", message=FALSE, warning=FALSE}

library(mixedcurve)
nxy <- 5000
xseq <- seq(0, 1, length.out = 100)
set.seed(123)
df1 <- mixedcurve::gen_hfanova_data(
  f = mixedcurve::m2, n = c(nxy, 2), sigmas = c(0.02, 0),
  bounds = list(c(0,1), c(0, 1)), ndim = 2,
  ngrp = 1, px = NULL, pxargs = NULL,
  family = "gaussian", white_noise = TRUE
)
mixedcurve::dark_mode()
color_scale <- viridis::viridis(100)
color_values <- cut(df1$y, breaks = 100, labels = FALSE)
par(mfrow = c(1, 1))
plot(df1$x1, df1$x2,
     col = color_scale[color_values],
     pch = 20, xlab = "x1", ylab = "x2",
     main = "Cuevas M2 (2d) function data (Group 1)", cex = 2.0)

#
```      

<!-- }}} Generate data -->

To fit the Nadaraya-Watson kernel regression model, we can use the `lpk`
function from the `mixedcurve` package. We will specify the bandwidth, kernel
type, and degree and the function `y ~ K_h(x1 * x2)` to indicate a
two-dimensional kernel regression on the 2d (product) space of `x1 * x2`.

<!-- {{{ Fit NW model -->
```{r, fig.filename="doppler_2d_fit.png", fig.width=20, fig.height=10, out.width="98%", message=FALSE, warning=FALSE}

# Fit Nadaraya-Watson kernel regression model (in parallel)
nq <- 25
qseq <- as.matrix(expand.grid(
  seq(0.0, 1.0, length.out = nq),
  seq(0.0, 1.0, length.out = nq))
)
bandwidth <- 0.015
cl <- parallel::makeCluster(parallel::detectCores() - 1)
invisible(parallel::clusterEvalQ(cl, library(mixedcurve)))
parallel::clusterExport(cl, varlist = c("df1", "bandwidth", "qseq"))
lpk2 <- mixedcurve::lpk(y ~ K_h(x1 * x2),
  alternative_hypothesis = y ~ K_h(x1 * x2 | -1),
  queries = qseq,
  data = df1, degree = 0, kernel = mixedcurve::gauss_kern,
  h = bandwidth, parallel = TRUE, cl = cl, kthresh = 0.1
)
parallel::stopCluster(cl)
fits <- as.numeric(unlist(lapply(lpk2[[1]], function (fit) fit$coefs)))
all_values <- c(fits, mixedcurve::m2(qseq, 1))
breaks <- seq(min(all_values), max(all_values), length.out = 101)
colors <- viridis::viridis(100)
mixedcurve::dark_mode()
par(mfrow = c(1, 2))
image(matrix(mixedcurve::m2(qseq, 1), nq, nq),
  col = colors, breaks = breaks,
  axes = FALSE, main = "Cuevas M2 True Function (Group 1)"
)
image(matrix(fits, nq, nq),
  col = colors, breaks = breaks,
  axes = FALSE, main = paste("Nadaraya-Watson Fit Cuevas M2 (Group 1)")
)

```
<!-- }}} Fit NW model -->

## WY Adjusted Test

We can also compute Westfall-Young adjusted p-values for the fitted model using

<!-- {{{ WY adjusted p-values  -->

```{r, fig.filename="doppler_wy.png", fig.width=20, fig.height=10, out.width="98%", message=FALSE, warning=FALSE}

cl <- parallel::makeCluster(parallel::detectCores() - 1)
invisible(parallel::clusterEvalQ(cl, library(mixedcurve)))
parallel::clusterExport(cl, varlist = c("df1", "bandwidth", "qseq"))
wy_pvals <- mixedcurve::wy_one_step(
  dataf = df1, xseq = qseq, nperm = 50,
  gen_pvals_fun = function(data, xseq) {
    lpk_res <- mixedcurve::lpk(
      y ~ K_h(x1 * x2), queries = xseq, data = data, degree = 0,
      kernel = mixedcurve::box_kern,
      h = bandwidth, parallel = FALSE,
      alternative_hypothesis = y ~ K_h(x1 * x2 | -1),
      kthresh = 0.1
    )
    as.numeric(do.call(cbind, lapply(lpk_res[[1]], function(elmt) {
      elmt$pvals
    })))
  },
  gen_perm_fun = function(data) {
    data$y <- sample(data$y, replace = FALSE)
    data
  },
  cl = cl
)
parallel::stopCluster(cl)
color_values <- cut(wy_pvals, breaks = 100, labels = FALSE)
colors <- viridis::viridis(100)
mixedcurve::dark_mode()
par(mfrow = c(1, 2))
image(matrix(fits, nq, nq),
  col = colors, breaks = breaks,
  axes = FALSE, main = paste("Nadaraya-Watson Fit Cuevas M2 (Group 1)")
)
image(matrix(wy_pvals, nrow = nq, ncol = nq),
  col = colors,
  axes = FALSE,
  main = "Westfall-Young Adjusted P-values"
)

```

<!-- }}} WY adjusted p-values  -->

We see that there is a large region in the central part of the domain where the
Westfall-Young adjusted p-values are below the 0.05 significance threshold,
corresponding to larger values of data, indicating that we can reject the null
hypothesis that the mean function is equal to zero function. Further, we can
see that the p-values are high for large region outside of that where the
function is close to zero indicating regions where we do not have sufficient
evidence to reject the null hypothesis.
