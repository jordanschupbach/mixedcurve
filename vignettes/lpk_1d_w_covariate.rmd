---
title: "Nadaraya-Watson (1d) Kernel Regression w/ Covariate"
author: "Jordan Schupbach"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Nadaraya-Watson (1d) Kernel Regression w/ Covariate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- {{{ Setup  -->

```{r setup}
#| include: false
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<!-- }}} Setup  -->

## Introduction

This vignette demonstrates how to use the `mixedcurve` package to fit a
Nadaraya-Watson kernel regression model to one-dimensional data with a single
covariate and to conduct inference on that covariate using Westfall-Young adjusted p-values.

## Example Usage

Let's start by simulating some data according to the m3 Cuevas et al. function:

<!-- {{{ Generate data -->

```{r, fig.filename="m2_data.png", fig.width=7, fig.height=7, out.width = "78%", message=FALSE, warning=FALSE}

tf <- function(t, i) {
  mixedcurve::m3(t, i)
}
n <- 2000
set.seed(123)
# 2. Simulate the data
df1 <- mixedcurve::gen_hfanova_data(
  f = tf,
  ngrp = 3,
  n = c(500, 1), sigmas = c(0.03, 0), bounds = c(0, 1),
  ndim = 1, px = NULL, pxargs = NULL,
  family = "gaussian", white_noise = TRUE
)
# 3. Plot the data
mixedcurve::dark_mode()
plot(df1$x1, df1$y,
  col = adjustcolor(df1$cov, 0.1),
  pch = 20, 
  ylab = "y", xlab = "x1",
  main = "Modified M3 Poisson Fit"
)
qsq <- seq(0.0, 1.0, length.out = 1000)
lines(qsq, tf(qsq, 1), col = 1, lwd = 3)
lines(qsq, tf(qsq, 2), col = 2, lwd = 3)
lines(qsq, tf(qsq, 3), col = 3, lwd = 3)
legend("topright",
  legend = c("Group 1", "Group 2", "Group 3"), lty = 1, lwd = 3,
  col = c(adjustcolor(1, 1.00), adjustcolor(2, 1.00), adjustcolor(3, 1.00))
)

```

<!-- }}} Generate data -->

To fit the Nadaraya-Watson kernel regression model, we can use the `lpk`
function from the `mixedcurve` package. We will specify the bandwidth, kernel
type, and degree.
 
<!-- {{{ Fit NW model -->

```{r, fig.filename="m2_fit.png", fig.width=7, fig.height=7, out.width = "78%", message=FALSE, warning=FALSE}

# Fit Nadaraya-Watson kernel regression model (in parallel)
bandwidth <- 0.02
queries <- seq(0, 1, length.out = 100)
cl <- parallel::makeCluster(parallel::detectCores() - 1)
invisible(parallel::clusterEvalQ(cl, library(mixedcurve)))
parallel::clusterExport(cl, varlist = c("df1", "bandwidth", "queries"))
nw_fit <- mixedcurve::lpk(y ~ K_h(x1 | cov), h = bandwidth,
                          kernel = mixedcurve::box_kern, degree = 0,
                          data = df1, queries = queries,
                          parallel = TRUE, cl = cl)
parallel::stopCluster(cl)
# Extract the fits
coefs <- matrix(unlist(lapply(nw_fit[[1]], function(fit) fit$coefs)),
                ncol = 3, byrow = TRUE)
fits <- cbind(coefs[, 1], coefs[, 1] + coefs[, 2], coefs[, 1] + coefs[, 3])
mixedcurve::dark_mode()
plot(df1$x1, df1$y, main = "Nadaraya-Watson Kernel Regression of M2 data",
     pch = 20, col = adjustcolor(df1$cov, 0.6), cex = 1.0,
     xlab = "x", ylab = "y")
for (i in 1:3) {
  lines(queries, fits[, i], col = adjustcolor(i, 1.0), lwd = 2)
}
legend("topright",
       legend = c("Fit Group 1", "Fit Group 2", "Fit Group 3", "Raw Data"),
       lty = c(1, 1, 1, NA), pch = c(NA, NA, NA, 20),
       col = c(adjustcolor(1, 1.0), adjustcolor(2, 1.0), adjustcolor(3, 1.0),
               adjustcolor("white", 0.5)), bty = "n")

```

<!-- }}} Fit NW model -->

## WY adjusted test

We can also compute Westfall-Young adjusted p-values for the fitted model using
the `wy_full` function (or the `wy_one_step` function).

<!-- {{{ WY adjusted p-values  -->
```{r, fig.filename="m2_wy.png", fig.width=7, fig.height=10,  message=FALSE, warning=FALSE}

cl <- parallel::makeCluster(parallel::detectCores() - 1)
invisible(parallel::clusterEvalQ(cl, library(mixedcurve)))
parallel::clusterExport(cl, varlist = c("df1", "bandwidth", "queries"))
wy_pvals <- mixedcurve::wy_full(
  dataf = df1, xseq = queries, nperm = 100,
  gen_pvals_fun = function(data, xseq) {
    lpk_res <- mixedcurve::lpk(
      y ~ K_h(x1 | cov),
      alternative_hypothesis = y ~ K_h(x1 | -1),
      queries = xseq, data = data, degree = 0,
      kernel = mixedcurve::box_kern, h = bandwidth, 
      kthresh = 0.1,
      parallel = FALSE
    )
    as.numeric(lapply(lpk_res[[1]], function(elmt) {
      elmt$pvals
    }))
  },
  gen_perm_fun = function(data) {
    data$cov <- sample(data$cov, replace = FALSE)
    data
  },
  cl = cl
)
parallel::stopCluster(cl)
par(mfrow = c(2, 1))
mixedcurve::dark_mode()
plot(df1$x1, df1$y, main = "Nadaraya-Watson Kernel Regression of M2 data",
     pch = 20, col = adjustcolor(df1$cov, 0.6), cex = 1.0,
     xlab = "x", ylab = "y")
for (i in 1:3) {
  lines(queries, fits[, i], col = adjustcolor(i, 1.0), lwd = 2)
}
legend("topright", legend = c("Fit Group 1", "Fit Group 2",
                              "Fit Group 3", "Raw Data"),
       lty = c(1, 1, 1, NA), pch = c(NA, NA, NA, 20),
       col = c(adjustcolor(1, 1.0), adjustcolor(2, 1.0), adjustcolor(3, 1.0),
               adjustcolor("white", 0.5)), bty = "n")
mixedcurve::plot_pval_regions(queries, wy_pvals, pthresh = 0.05, ylim = c(-2, 2))
plot(queries, wy_pvals, type = "l",
  main = "Westfall-Young adjusted p-values",
  xlab = "x", ylab = "W-Y Adjusted p-value"
)
mixedcurve::plot_pval_regions(queries, wy_pvals, pthresh = 0.05)
print(paste0("WY-Adjusted p-value: ", min(wy_pvals)))

```
<!-- }}} WY adjusted p-values  -->

